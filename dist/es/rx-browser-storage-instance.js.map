{"version":3,"sources":["../../src/rx-browser-storage-instance.ts"],"names":["require","filterInMemoryFields","instanceId","RxStorageBrowserInstance","databaseName","collectionName","options","schema","internals","changes$","Subject","closed","lastChangefeedSequence","prepareQuery","mutateableQuery","getSortComparator","query","sortOptions","sort","primaryPath","fun","a","b","compareResult","forEach","sortPart","fieldName","Object","keys","direction","values","directionMultiplier","valueA","valueB","args","getQueryMatcher","doc","console","log","_attachments","_deleted","_rev","json","inMemoryFields","length","preparedQuery","db","getLocalState","rows","bulkWrite","documentWrites","txn","transaction","store","ret","success","Map","error","writeRow","startTime","Date","now","id","document","openCursor","documentInDbCursor","documentInDb","value","newRevision","insertedIsDeleted","writeDoc","assign","add","addChangeDocumentMeta","next","eventId","documentId","change","operation","previous","endTime","set","revInDb","err","isError","status","newRevHeight","$loki","update","commit","bulkAddRevisions","documents","localState","docData","newWriteRevision","oldRevision","mustUpdate","height","hash","docDataCpy","findDocumentsById","ids","deleted","get","getChangedDocuments","desc","operator","changesCollectionName","index","cursor","changedDocuments","push","limit","slice","map","result","sequence","useForLastSequence","lastSequence","sinceSequence","changeStream","asObservable","getAttachmentData","_documentId","_attachmentId","Error","close","complete","IDB_DATABASE_STATE_BY_NAME","remove","databaseState","lastDoc","nextFeedSequence","createBrowserStorageLocalState","params","primaryKey","toString","createBrowserStorageInstance","instance"],"mappings":"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","sourcesContent":["import {\r\n  BlobBuffer,\r\n  BulkWriteRow,\r\n  ChangeStreamOnceOptions,\r\n  MangoQuery,\r\n  MangoQuerySortDirection,\r\n  MangoQuerySortPart,\r\n  RxDocumentData,\r\n  RxDocumentWriteData,\r\n  RxJsonSchema,\r\n  RxStorageBulkWriteError,\r\n  RxStorageBulkWriteResponse,\r\n  RxStorageChangedDocumentMeta,\r\n  RxStorageChangeEvent,\r\n  RxStorageInstance,\r\n  RxStorageInstanceCreationParams,\r\n  RxStorageQueryResult,\r\n} from \"rxdb/dist/types/types\";\r\nimport { Observable, Subject } from \"rxjs\";\r\nimport {\r\n  BrowserStorageInternals,\r\n  BrowserStorageSettings,\r\n} from \"./types/browser-storage\";\r\nimport {\r\n  getIdbDatabase,\r\n  getPrimaryFieldOfPrimaryKey,\r\n  IDB_DATABASE_STATE_BY_NAME,\r\n  newRxError,\r\n} from \"./db-helpers\";\r\nimport {\r\n  ChangeEvent,\r\n  DeterministicSortComparator,\r\n  QueryMatcher,\r\n} from \"event-reduce-js/dist/lib/types\";\r\nimport { find } from \"./find\";\r\nimport { createRevision, getHeightOfRevision, parseRevision } from \"rxdb\";\r\nimport { getEventKey } from \"./utils\";\r\nimport { deleteDB } from \"idb\";\r\nconst { filterInMemoryFields } = require(\"pouchdb-selector-core\");\r\n\r\nlet instanceId = 1;\r\n\r\nexport class RxStorageBrowserInstance<RxDocType>\r\n  implements\r\n    RxStorageInstance<\r\n      RxDocType,\r\n      BrowserStorageInternals,\r\n      BrowserStorageSettings\r\n    >\r\n{\r\n  //   public readonly primaryPath: keyof RxDocType;\r\n  private changes$: Subject<RxStorageChangeEvent<RxDocumentData<RxDocType>>> =\r\n    new Subject();\r\n  public readonly instanceId = instanceId++;\r\n  private closed = false;\r\n  private lastChangefeedSequence: number = 0;\r\n\r\n  constructor(\r\n    public readonly databaseName: string,\r\n    public readonly collectionName: string,\r\n    public readonly options: Readonly<BrowserStorageSettings>,\r\n    public readonly schema: Readonly<RxJsonSchema<RxDocType>>,\r\n    public readonly internals: BrowserStorageInternals // public readonly options: Readonly<BrowserStorageSettings> // public readonly databaseSettings: BrowserStorageSettings, // public readonly idleQueue: IdleQueue\r\n  ) {\r\n    // this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\r\n  }\r\n\r\n  prepareQuery(mutateableQuery: MangoQuery<RxDocType>) {\r\n    return mutateableQuery;\r\n  }\r\n\r\n  getSortComparator(query: MangoQuery<RxDocType>) {\r\n    // TODO if no sort is given, use sort by primary.\r\n    // This should be done inside of RxDB and not in the storage implementations.\r\n    const sortOptions: MangoQuerySortPart<RxDocType>[] = query.sort\r\n      ? (query.sort as any)\r\n      : [\r\n          {\r\n            [this.internals.primaryPath]: \"asc\",\r\n          },\r\n        ];\r\n\r\n    const fun: DeterministicSortComparator<RxDocType> = (\r\n      a: RxDocType,\r\n      b: RxDocType\r\n    ) => {\r\n      let compareResult: number = 0;\r\n      sortOptions.forEach((sortPart) => {\r\n        const fieldName: string = Object.keys(sortPart)[0];\r\n        const direction: MangoQuerySortDirection = Object.values(sortPart)[0];\r\n        const directionMultiplier = direction === \"asc\" ? 1 : -1;\r\n        const valueA: any = (a as any)[fieldName];\r\n        const valueB: any = (b as any)[fieldName];\r\n        if (valueA === valueB) {\r\n          return;\r\n        } else {\r\n          if (valueA > valueB) {\r\n            compareResult = 1 * directionMultiplier;\r\n          } else {\r\n            compareResult = -1 * directionMultiplier;\r\n          }\r\n        }\r\n      });\r\n\r\n      /**\r\n       * Two different objects should never have the same sort position.\r\n       * We ensure this by having the unique primaryKey in the sort params\r\n       * at this.prepareQuery()\r\n       */\r\n      if (!compareResult) {\r\n        throw newRxError(\"SNH\", { args: { query, a, b } });\r\n      }\r\n\r\n      return compareResult as 1 | -1;\r\n    };\r\n\r\n    return fun;\r\n  }\r\n\r\n  getQueryMatcher(query: MangoQuery<RxDocType>) {\r\n    const fun: QueryMatcher<RxDocumentWriteData<RxDocType>> = (\r\n      doc: RxDocumentWriteData<RxDocType>\r\n    ) => {\r\n      console.log(\"getQueryMatcher doc:\", doc);\r\n      const { _attachments, _deleted, _rev, ...json } = doc;\r\n      const inMemoryFields = Object.keys(json);\r\n      return filterInMemoryFields([json], query, inMemoryFields).length > 0;\r\n    };\r\n\r\n    return fun;\r\n  }\r\n\r\n  async query(\r\n    preparedQuery: MangoQuery<RxDocType>\r\n  ): Promise<RxStorageQueryResult<RxDocType>> {\r\n    const db = this.getLocalState().db;\r\n    const rows = await find(db, this.collectionName, preparedQuery);\r\n    return rows;\r\n  }\r\n\r\n  async bulkWrite(\r\n    documentWrites: BulkWriteRow<RxDocType>[]\r\n  ): Promise<RxStorageBulkWriteResponse<RxDocType>> {\r\n    if (documentWrites.length === 0) {\r\n      throw newRxError(\"P2\", {\r\n        args: {\r\n          documentWrites,\r\n        },\r\n      });\r\n    }\r\n\r\n    const db = this.getLocalState().db;\r\n    const txn = db.transaction(this.collectionName, \"readwrite\");\r\n    const store = txn.store;\r\n\r\n    const ret: RxStorageBulkWriteResponse<RxDocType> = {\r\n      success: new Map(),\r\n      error: new Map(),\r\n    };\r\n\r\n    for (const writeRow of documentWrites) {\r\n      const startTime = Date.now();\r\n      const id: string = (writeRow.document as any)[this.internals.primaryPath];\r\n      // TODO: probably will have problems here.\r\n      const documentInDbCursor = await store.openCursor(id);\r\n      const documentInDb = documentInDbCursor?.value;\r\n      if (!documentInDb) {\r\n        // insert new document\r\n        const newRevision = \"1-\" + createRevision(writeRow.document);\r\n\r\n        /**\r\n         * It is possible to insert already deleted documents,\r\n         * this can happen on replication.\r\n         */\r\n        const insertedIsDeleted = writeRow.document._deleted ? true : false;\r\n        if (!insertedIsDeleted) {\r\n          // TODO: purge documents\r\n          continue;\r\n        }\r\n\r\n        const writeDoc = Object.assign({}, writeRow.document, {\r\n          _rev: newRevision,\r\n          _deleted: insertedIsDeleted,\r\n          // TODO attachments are currently not working with lokijs\r\n          _attachments: {} as any,\r\n        });\r\n\r\n        await store.add(writeDoc);\r\n        this.addChangeDocumentMeta(id);\r\n        this.changes$.next({\r\n          eventId: getEventKey(false, id, newRevision),\r\n          documentId: id,\r\n          change: {\r\n            doc: writeDoc,\r\n            id,\r\n            operation: \"INSERT\",\r\n            previous: null,\r\n          },\r\n          startTime,\r\n          endTime: Date.now(),\r\n        });\r\n        ret.success.set(id, writeDoc as any);\r\n      } else {\r\n        // update existing document\r\n        const revInDb: string = documentInDb._rev;\r\n\r\n        // inserting a deleted document is possible\r\n        // without sending the previous data.\r\n        // TODO: purge document\r\n        // if (!writeRow.previous && documentInDb._deleted) {\r\n        //   writeRow.previous = documentInDb;\r\n        // }\r\n\r\n        if (\r\n          (!writeRow.previous && !documentInDb._deleted) ||\r\n          (!!writeRow.previous && revInDb !== writeRow.previous._rev)\r\n        ) {\r\n          // conflict error\r\n          const err: RxStorageBulkWriteError<RxDocType> = {\r\n            isError: true,\r\n            status: 409,\r\n            documentId: id,\r\n            writeRow: writeRow,\r\n          };\r\n          ret.error.set(id, err);\r\n        } else {\r\n          const newRevHeight = getHeightOfRevision(revInDb) + 1;\r\n          const newRevision =\r\n            newRevHeight + \"-\" + createRevision(writeRow.document);\r\n\r\n          if (\r\n            writeRow.previous &&\r\n            !writeRow.previous._deleted &&\r\n            writeRow.document._deleted\r\n          ) {\r\n            // TODO: purge\r\n            await documentInDbCursor.delete();\r\n            this.addChangeDocumentMeta(id); // TODO: do I need this here.\r\n            const previous = Object.assign({}, writeRow.previous);\r\n            previous._rev = newRevision;\r\n            const change = {\r\n              id,\r\n              operation: \"DELETE\" as \"DELETE\",\r\n              previous,\r\n              doc: null,\r\n            };\r\n            this.changes$.next({\r\n              eventId: getEventKey(false, id, newRevision),\r\n              documentId: id,\r\n              change,\r\n              startTime,\r\n              endTime: Date.now(),\r\n            });\r\n            continue;\r\n          }\r\n\r\n          if (writeRow.document._deleted) {\r\n            throw newRxError(\"SNH\", { args: { writeRow } });\r\n          }\r\n\r\n          const writeDoc: any = Object.assign({}, writeRow.document, {\r\n            $loki: documentInDb.$loki,\r\n            _rev: newRevision,\r\n            _deleted: false,\r\n            _attachments: {}, // TODO: attachments\r\n          });\r\n          await documentInDbCursor.update(writeDoc);\r\n          this.addChangeDocumentMeta(id);\r\n\r\n          // TODO: stripIdbKey(writeDoc) ?\r\n          let change: ChangeEvent<RxDocumentData<RxDocType>> | null = null;\r\n          if (\r\n            writeRow.previous &&\r\n            writeRow.previous._deleted &&\r\n            !writeDoc._deleted\r\n          ) {\r\n            change = {\r\n              id,\r\n              operation: \"INSERT\",\r\n              previous: null,\r\n              doc: writeDoc,\r\n            };\r\n          } else if (\r\n            writeRow.previous &&\r\n            !writeRow.previous._deleted &&\r\n            !writeDoc._deleted\r\n          ) {\r\n            change = {\r\n              id,\r\n              operation: \"UPDATE\",\r\n              previous: writeRow.previous,\r\n              doc: writeDoc,\r\n            };\r\n          }\r\n          if (!change) {\r\n            throw newRxError(\"SNH\", { args: { writeRow } });\r\n          }\r\n          this.changes$.next({\r\n            eventId: getEventKey(false, id, newRevision),\r\n            documentId: id,\r\n            change,\r\n            startTime,\r\n            endTime: Date.now(),\r\n          });\r\n          ret.success.set(id, writeDoc);\r\n        }\r\n      }\r\n    }\r\n\r\n    txn.commit();\r\n    return ret;\r\n  }\r\n\r\n  async bulkAddRevisions(\r\n    documents: RxDocumentData<RxDocType>[]\r\n  ): Promise<void> {\r\n    if (documents.length === 0) {\r\n      throw newRxError(\"P3\", {\r\n        args: {\r\n          documents,\r\n        },\r\n      });\r\n    }\r\n\r\n    const localState = this.getLocalState();\r\n    const db = localState.db;\r\n    const txn = db.transaction(this.collectionName, \"readwrite\");\r\n    const store = txn.store;\r\n\r\n    // TODO: stripKey(documentInDb) ?\r\n    for (const docData of documents) {\r\n      const startTime = Date.now();\r\n      const id: string = (docData as any)[this.internals.primaryPath];\r\n      // TODO: probably will have problems here.\r\n      const documentInDbCursor = await store.openCursor(id);\r\n      const documentInDb = documentInDbCursor?.value;\r\n      if (!documentInDb) {\r\n        // document not here, so we can directly insert\r\n        await store.add(Object.assign({}, docData));\r\n\r\n        this.changes$.next({\r\n          documentId: id,\r\n          eventId: getEventKey(false, id, docData._rev),\r\n          change: {\r\n            doc: docData,\r\n            id,\r\n            operation: \"INSERT\",\r\n            previous: null,\r\n          },\r\n          startTime,\r\n          endTime: Date.now(),\r\n        });\r\n        this.addChangeDocumentMeta(id);\r\n      } else {\r\n        const newWriteRevision = parseRevision(docData._rev);\r\n        const oldRevision = parseRevision(documentInDb._rev);\r\n\r\n        let mustUpdate: boolean = false;\r\n        if (newWriteRevision.height !== oldRevision.height) {\r\n          // height not equal, compare base on height\r\n          if (newWriteRevision.height > oldRevision.height) {\r\n            mustUpdate = true;\r\n          }\r\n        } else if (newWriteRevision.hash > oldRevision.hash) {\r\n          // equal height but new write has the 'winning' hash\r\n          mustUpdate = true;\r\n        }\r\n        if (mustUpdate) {\r\n          const docDataCpy = Object.assign({}, docData);\r\n          documentInDbCursor.update(docDataCpy);\r\n          let change: ChangeEvent<RxDocumentData<RxDocType>> | null = null;\r\n          if (documentInDb._deleted && !docData._deleted) {\r\n            change = {\r\n              id,\r\n              operation: \"INSERT\",\r\n              previous: null,\r\n              doc: docData,\r\n            };\r\n          } else if (!documentInDb._deleted && !docData._deleted) {\r\n            change = {\r\n              id,\r\n              operation: \"UPDATE\",\r\n              previous: documentInDb,\r\n              doc: docData,\r\n            };\r\n          } else if (!documentInDb._deleted && docData._deleted) {\r\n            change = {\r\n              id,\r\n              operation: \"DELETE\",\r\n              previous: documentInDb,\r\n              doc: null,\r\n            };\r\n          } else if (documentInDb._deleted && docData._deleted) {\r\n            change = null;\r\n          }\r\n          if (change) {\r\n            this.changes$.next({\r\n              documentId: id,\r\n              eventId: getEventKey(false, id, docData._rev),\r\n              change,\r\n              startTime,\r\n              endTime: Date.now(),\r\n            });\r\n            this.addChangeDocumentMeta(id);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    txn.commit();\r\n  }\r\n\r\n  async findDocumentsById(\r\n    ids: string[],\r\n    deleted: boolean\r\n  ): Promise<Map<string, RxDocumentData<RxDocType>>> {\r\n    const localState = this.getLocalState();\r\n    const ret: Map<string, RxDocumentData<RxDocType>> = new Map();\r\n\r\n    const db = localState.db;\r\n    const store = await db.transaction(this.collectionName, \"readwrite\").store;\r\n    for (const id of ids) {\r\n      const documentInDb = await store.get(id);\r\n      if (documentInDb && (!documentInDb._deleted || deleted)) {\r\n        // TODO: stripKey(documentInDb) ?\r\n        ret.set(id, documentInDb);\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n\r\n  async getChangedDocuments(options: ChangeStreamOnceOptions): Promise<{\r\n    changedDocuments: RxStorageChangedDocumentMeta[];\r\n    lastSequence: number;\r\n  }> {\r\n    const localState = this.getLocalState();\r\n\r\n    const desc = options.direction === \"before\";\r\n    const operator = options.direction === \"after\" ? \"$gt\" : \"$lt\";\r\n\r\n    const changesCollectionName = localState.changesCollectionName;\r\n    const db = localState.db;\r\n    const store = db.transaction(changesCollectionName, \"readwrite\").store;\r\n    let cursor = await store\r\n      .index(\"sequence\")\r\n      .openCursor(null, desc ? \"prev\" : \"next\");\r\n    let changedDocuments = [];\r\n    while (cursor) {\r\n      const value = cursor.value;\r\n      changedDocuments.push(value);\r\n      cursor = await cursor.continue();\r\n    }\r\n\r\n    if (options.limit) {\r\n      changedDocuments = changedDocuments.slice(0, options.limit);\r\n    }\r\n\r\n    changedDocuments = changedDocuments.map((result) => {\r\n      return {\r\n        id: result.id,\r\n        sequence: result.sequence,\r\n      };\r\n    });\r\n\r\n    const useForLastSequence = !desc\r\n      ? changedDocuments[changedDocuments.length - 1]\r\n      : changedDocuments[0];\r\n\r\n    const ret: {\r\n      changedDocuments: RxStorageChangedDocumentMeta[];\r\n      lastSequence: number;\r\n    } = {\r\n      changedDocuments,\r\n      lastSequence: useForLastSequence\r\n        ? useForLastSequence.sequence\r\n        : options.sinceSequence,\r\n    };\r\n\r\n    return ret;\r\n  }\r\n\r\n  changeStream(): Observable<RxStorageChangeEvent<RxDocumentData<RxDocType>>> {\r\n    return this.changes$.asObservable();\r\n  }\r\n\r\n  getAttachmentData(\r\n    _documentId: string,\r\n    _attachmentId: string\r\n  ): Promise<BlobBuffer> {\r\n    // TODO: attacments\r\n    throw new Error(\r\n      \"Attachments are not implemented in the lokijs RxStorage. Make a pull request.\"\r\n    );\r\n  }\r\n\r\n  async close(): Promise<void> {\r\n    this.closed = true;\r\n    this.changes$.complete();\r\n    IDB_DATABASE_STATE_BY_NAME.delete(this.databaseName);\r\n\r\n    const localState = this.getLocalState();\r\n    localState.db.close();\r\n  }\r\n  async remove(): Promise<void> {\r\n    this.close();\r\n    // TODO: it can be a problem actually.\r\n    // The connection is not actually closed until all transactions created using this connection are complete.\r\n    await deleteDB(this.databaseName);\r\n    this.closed = true;\r\n  }\r\n\r\n  private getLocalState() {\r\n    const localState = this.internals.databaseState;\r\n    if (!localState) {\r\n      throw new Error(`localState is undefind (dbName: ${this.databaseName})`);\r\n    }\r\n\r\n    return localState;\r\n  }\r\n\r\n  /**\r\n   * Adds an entry to the changes feed\r\n   * that can be queried to check which documents have been\r\n   * changed since sequence X.\r\n   */\r\n  private async addChangeDocumentMeta(id: string) {\r\n    const localState = this.getLocalState();\r\n    const changesCollectionName = localState.changesCollectionName;\r\n    const db = localState.db;\r\n    const store = db.transaction(changesCollectionName, \"readwrite\").store;\r\n\r\n    if (!this.lastChangefeedSequence) {\r\n      const cursor = await store.index(\"sequence\").openCursor(null, \"prev\");\r\n      const lastDoc = cursor?.value;\r\n      if (lastDoc) {\r\n        this.lastChangefeedSequence = lastDoc.sequence;\r\n      }\r\n    }\r\n\r\n    const nextFeedSequence = this.lastChangefeedSequence + 1;\r\n\r\n    await store.add({\r\n      id,\r\n      sequence: nextFeedSequence,\r\n    });\r\n\r\n    this.lastChangefeedSequence = nextFeedSequence;\r\n  }\r\n}\r\n\r\nexport const createBrowserStorageLocalState = async <RxDocType>(\r\n  params: RxStorageInstanceCreationParams<RxDocType, BrowserStorageSettings>\r\n): Promise<BrowserStorageInternals> => {\r\n  const primaryPath = getPrimaryFieldOfPrimaryKey(\r\n    params.schema.primaryKey\r\n  ).toString();\r\n  const databaseState = await getIdbDatabase(\r\n    params.databaseName,\r\n    params.collectionName,\r\n    primaryPath,\r\n    params.schema\r\n  );\r\n\r\n  return {\r\n    databaseState,\r\n    primaryPath,\r\n  };\r\n};\r\n\r\nexport const createBrowserStorageInstance = async <RxDocType>(\r\n  params: RxStorageInstanceCreationParams<RxDocType, BrowserStorageSettings>\r\n) => {\r\n  const internals: BrowserStorageInternals =\r\n    await createBrowserStorageLocalState(params);\r\n\r\n  const instance = new RxStorageBrowserInstance(\r\n    params.databaseName,\r\n    params.collectionName,\r\n    {},\r\n    params.schema,\r\n    internals\r\n  );\r\n\r\n  /**\r\n   * TODO: should we do extra steps to enable CORRECT multiinstance?\r\n   */\r\n\r\n  return instance;\r\n};\r\n"],"file":"rx-browser-storage-instance.js"}