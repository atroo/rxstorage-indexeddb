{"version":3,"sources":["../../src/find.ts"],"names":["require","filterInMemoryFields","find","db","collectionName","query","translatedSelector","firstIndexedField","fields","opts","startkey","queryOpts","undefined","endkey","inclusive_start","inclusive_end","keyRange","store","transaction","index","openCursor","cursor","rows","key","value","push","length","inMemoryFields","slice"],"mappings":";;;;;;;;;;;;;AAEA;;AACA;;AAEA,eAAiCA,OAAO,CAAC,uBAAD,CAAxC;AAAA,IAAQC,oBAAR,YAAQA,oBAAR;;AAEO,IAAMC,IAAI;AAAA,2FAAG,iBAClBC,EADkB,EAElBC,cAFkB,EAGlBC,KAHkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAKZC,YAAAA,kBALY,GAKS,mCAA4BD,KAA5B,CALT,EAOlB;;AACME,YAAAA,iBARY,GAQQD,kBAAkB,CAACE,MAAnB,CAA0B,CAA1B,CARR,EAQsC;;AAClDC,YAAAA,IATY,GASgB;AAChCC,cAAAA,QAAQ,EAAEJ,kBAAkB,CAACK,SAAnB,CAA6BD,QAA7B,GACNJ,kBAAkB,CAACK,SAAnB,CAA6BD,QAA7B,CAAsC,CAAtC,CADM,GAENE,SAH4B;AAIhCC,cAAAA,MAAM,EAAEP,kBAAkB,CAACK,SAAnB,CAA6BE,MAA7B,GACJP,kBAAkB,CAACK,SAAnB,CAA6BE,MAA7B,CAAoC,CAApC,CADI,GAEJD,SAN4B;AAOhCE,cAAAA,eAAe,EAAER,kBAAkB,CAACK,SAAnB,CAA6BG,eAPd;AAQhCC,cAAAA,aAAa,EAAET,kBAAkB,CAACK,SAAnB,CAA6BI;AARZ,aAThB;AAoBZC,YAAAA,QApBY,GAoBD,mCAAiBP,IAAjB,CApBC;AAsBZQ,YAAAA,KAtBY,GAsBJd,EAAE,CAACe,WAAH,CAAed,cAAf,EAA+B,WAA/B,EAA4Ca,KAtBxC;AAuBZE,YAAAA,KAvBY,GAuBJF,KAAK,CAACE,KAAN,CAAYZ,iBAAZ,CAvBI;AAAA;AAAA,mBAwBCY,KAAK,CAACC,UAAN,CAAiBJ,QAAjB,CAxBD;;AAAA;AAwBdK,YAAAA,MAxBc;AA0BdC,YAAAA,IA1Bc,GA0BP,EA1BO;;AAAA;AAAA,iBA2BXD,MA3BW;AAAA;AAAA;AAAA;;AA4BVE,YAAAA,GA5BU,GA4BJF,MAAM,CAACE,GA5BH;AA6BVC,YAAAA,KA7BU,GA6BFH,MAAM,CAACG,KA7BL;AA8BhBF,YAAAA,IAAI,CAACG,IAAL,CAAUD,KAAV;AA9BgB;AAAA,mBA+BDH,MAAM,YAAN,EA/BC;;AAAA;AA+BhBA,YAAAA,MA/BgB;AAAA;AAAA;;AAAA;AAkClB;AACA;AACA,gBAAIf,kBAAkB,CAACE,MAAnB,CAA0BkB,MAA1B,GAAmC,CAAvC,EAA0C;AAClCC,cAAAA,cADkC,GACjBrB,kBAAkB,CAACE,MAAnB,CAA0BoB,KAA1B,CAAgC,CAAhC,CADiB;AAExCN,cAAAA,IAAI,GAAGrB,oBAAoB,CAACqB,IAAD,EAAOjB,KAAP,EAAcsB,cAAd,CAA3B;AACD;;AAvCiB,6CAyCXL,IAzCW;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAAJpB,IAAI;AAAA;AAAA;AAAA,GAAV","sourcesContent":["import { IDBPDatabase } from \"idb\";\r\nimport { MangoQuery } from \"rxdb/dist/types/types\";\r\nimport { translateMangoQuerySelector } from \".\";\r\nimport { generateKeyRange } from \"./idb-key-range\";\r\nimport { IIdbKeyRangeOptions } from \"./types/translate-mango-query\";\r\nconst { filterInMemoryFields } = require(\"pouchdb-selector-core\");\r\n\r\nexport const find = async <RxDocType>(\r\n  db: IDBPDatabase<unknown>,\r\n  collectionName: string,\r\n  query: MangoQuery<RxDocType>\r\n) => {\r\n  const translatedSelector = translateMangoQuerySelector(query);\r\n\r\n  // TODO: use indexed field to generate opts\r\n  const firstIndexedField = translatedSelector.fields[0]; // TODO: can be undefined?\r\n  const opts: IIdbKeyRangeOptions = {\r\n    startkey: translatedSelector.queryOpts.startkey\r\n      ? translatedSelector.queryOpts.startkey[0]\r\n      : undefined,\r\n    endkey: translatedSelector.queryOpts.endkey\r\n      ? translatedSelector.queryOpts.endkey[0]\r\n      : undefined,\r\n    inclusive_start: translatedSelector.queryOpts.inclusive_start,\r\n    inclusive_end: translatedSelector.queryOpts.inclusive_end,\r\n  };\r\n\r\n  const keyRange = generateKeyRange(opts);\r\n\r\n  const store = db.transaction(collectionName, \"readwrite\").store;\r\n  const index = store.index(firstIndexedField);\r\n  let cursor = await index.openCursor(keyRange);\r\n\r\n  let rows = [];\r\n  while (cursor) {\r\n    const key = cursor.key;\r\n    const value = cursor.value;\r\n    rows.push(value);\r\n    cursor = await cursor.continue();\r\n  }\r\n\r\n  // TODO: currently that there should be single indexed key.\r\n  // And everything else should be in memory fields.\r\n  if (translatedSelector.fields.length > 1) {\r\n    const inMemoryFields = translatedSelector.fields.slice(1);\r\n    rows = filterInMemoryFields(rows, query, inMemoryFields);\r\n  }\r\n\r\n  return rows;\r\n};\r\n"],"file":"find.js"}