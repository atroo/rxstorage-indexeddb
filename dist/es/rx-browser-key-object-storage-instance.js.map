{"version":3,"sources":["../../src/rx-browser-key-object-storage-instance.ts"],"names":["instanceId","RxStorageKeyObjectInstanceLoki","databaseName","collectionName","options","internals","changes$","Subject","closed","bulkWrite","documentWrites","length","args","getLocalState","getDb","db","txn","transaction","store","ret","success","Map","error","writeRowById","startTime","Date","now","writeRow","id","document","_id","set","openCursor","documentInDbCursor","writeDoc","Object","assign","docInDb","value","previous","newRevHeight","_rev","height","newRevision","err","isError","status","documentId","_deleted","docCpy","update","add","endTime","event","operation","doc","previousDoc","eventId","storageChangeEvent","change","next","commit","findLocalDocumentsById","ids","localState","get","documentInDb","changeStream","asObservable","close","complete","IDB_DATABASE_STATE_BY_NAME","remove","databaseState","Error","createBrowserKeyValueStorageLocalState","params","primaryPath","indexes","version","createBrowserKeyObjectStorageInstance","instance"],"mappings":"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","sourcesContent":["import { ChangeEvent } from \"event-reduce-js/dist/lib/types\";\r\nimport { deleteDB } from \"idb\";\r\nimport { createRevision, parseRevision } from \"rxdb\";\r\nimport {\r\n  BulkWriteLocalRow,\r\n  RxDocumentData,\r\n  RxKeyObjectStorageInstanceCreationParams,\r\n  RxLocalDocumentData,\r\n  RxLocalStorageBulkWriteResponse,\r\n  RxStorageBulkWriteLocalError,\r\n  RxStorageChangeEvent,\r\n  RxStorageKeyObjectInstance,\r\n} from \"rxdb/dist/types/types\";\r\nimport { Observable, Subject } from \"rxjs\";\r\nimport {\r\n  getIdbDatabase,\r\n  IDB_DATABASE_STATE_BY_NAME,\r\n  newRxError,\r\n} from \"./db-helpers\";\r\nimport {\r\n  BrowserStorageInternals,\r\n  BrowserStorageSettings,\r\n} from \"./types/browser-storage\";\r\nimport { getEventKey } from \"./utils\";\r\n\r\nlet instanceId = 1;\r\n\r\nexport class RxStorageKeyObjectInstanceLoki<RxDocType>\r\n  implements\r\n    RxStorageKeyObjectInstance<BrowserStorageInternals, BrowserStorageSettings>\r\n{\r\n  private changes$: Subject<\r\n    RxStorageChangeEvent<RxLocalDocumentData<RxDocType>>\r\n  > = new Subject();\r\n  public readonly instanceId = instanceId++;\r\n  private closed = false;\r\n\r\n  constructor(\r\n    public readonly databaseName: string,\r\n    public readonly collectionName: string,\r\n    public readonly options: Readonly<BrowserStorageSettings>,\r\n    public readonly internals: BrowserStorageInternals // public readonly options: Readonly<BrowserStorageSettings> // public readonly databaseSettings: BrowserStorageSettings, // public readonly idleQueue: IdleQueue\r\n  ) {\r\n    // this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\r\n  }\r\n\r\n  async bulkWrite<RxDocType>(\r\n    documentWrites: BulkWriteLocalRow<RxDocType>[]\r\n  ): Promise<RxLocalStorageBulkWriteResponse<RxDocType>> {\r\n    if (documentWrites.length === 0) {\r\n      throw newRxError(\"P2\", {\r\n        args: {\r\n          documentWrites,\r\n        },\r\n      });\r\n    }\r\n\r\n    const db = await this.getLocalState().getDb();\r\n    const txn = db.transaction(this.collectionName, \"readwrite\");\r\n    const store = txn.store;\r\n\r\n    const ret: RxLocalStorageBulkWriteResponse<RxDocType> = {\r\n      success: new Map(),\r\n      error: new Map(),\r\n    };\r\n    const writeRowById: Map<string, BulkWriteLocalRow<RxDocType>> = new Map();\r\n    const startTime = Date.now();\r\n\r\n    for (const writeRow of documentWrites) {\r\n      const id = writeRow.document._id;\r\n      writeRowById.set(id, writeRow);\r\n      const documentInDbCursor = await store.openCursor(id);\r\n      const writeDoc = Object.assign({}, writeRow.document);\r\n      const docInDb = documentInDbCursor?.value;\r\n      const previous = writeRow.previous ? writeRow.previous : docInDb;\r\n      const newRevHeight = previous\r\n        ? parseRevision(previous._rev).height + 1\r\n        : 1;\r\n      const newRevision =\r\n        newRevHeight + \"-\" + createRevision(writeRow.document);\r\n      writeDoc._rev = newRevision;\r\n      if (docInDb) {\r\n        if (!writeRow.previous || docInDb._rev !== writeRow.previous._rev) {\r\n          // conflict error\r\n          const err: RxStorageBulkWriteLocalError<RxDocType> = {\r\n            isError: true,\r\n            status: 409,\r\n            documentId: id,\r\n            writeRow: writeRow,\r\n          };\r\n          ret.error.set(id, err);\r\n          continue;\r\n        } else if (!writeRow.document._deleted) {\r\n          const docCpy: any = Object.assign({}, writeDoc);\r\n          await documentInDbCursor.update(writeDoc);\r\n        } else {\r\n          // TODO: purge\r\n          await documentInDbCursor.delete();\r\n        }\r\n      } else if (!writeRow.document._deleted) {\r\n        // TODO: purge\r\n        await store.add(Object.assign({}, writeDoc));\r\n      }\r\n\r\n      // TODO: strip?\r\n      ret.success.set(id, writeDoc);\r\n\r\n      const endTime = Date.now();\r\n\r\n      let event: ChangeEvent<RxLocalDocumentData<RxDocType>>;\r\n      if (!writeRow.previous) {\r\n        // was insert\r\n        event = {\r\n          operation: \"INSERT\",\r\n          doc: writeDoc,\r\n          id: id,\r\n          previous: null,\r\n        };\r\n      } else if (writeRow.document._deleted) {\r\n        // was delete\r\n\r\n        // we need to add the new revision to the previous doc\r\n        // so that the eventkey is calculated correctly.\r\n        // Is this a hack? idk.\r\n        const previousDoc = Object.assign({}, writeRow.previous);\r\n        previousDoc._rev = newRevision;\r\n\r\n        event = {\r\n          operation: \"DELETE\",\r\n          doc: null,\r\n          id,\r\n          previous: previousDoc,\r\n        };\r\n      } else {\r\n        // was update\r\n        event = {\r\n          operation: \"UPDATE\",\r\n          doc: writeDoc,\r\n          id: id,\r\n          previous: writeRow.previous,\r\n        };\r\n      }\r\n\r\n      if (\r\n        writeRow.document._deleted &&\r\n        (!writeRow.previous || writeRow.previous._deleted)\r\n      ) {\r\n        /**\r\n         * An already deleted document was added to the storage engine,\r\n         * do not emit an event because it does not affect anything.\r\n         */\r\n      } else {\r\n        const doc: RxLocalDocumentData<RxDocType> =\r\n          event.operation === \"DELETE\"\r\n            ? (event.previous as any)\r\n            : (event.doc as any);\r\n        const eventId = getEventKey(true, doc._id, doc._rev ? doc._rev : \"\");\r\n        const storageChangeEvent: RxStorageChangeEvent<\r\n          RxLocalDocumentData<RxDocType>\r\n        > = {\r\n          eventId,\r\n          documentId: id,\r\n          change: event,\r\n          startTime,\r\n          endTime,\r\n        };\r\n        // TODO: fix type\r\n        this.changes$.next(storageChangeEvent as any);\r\n      }\r\n    }\r\n\r\n    txn.commit();\r\n    return ret;\r\n  }\r\n\r\n  async findLocalDocumentsById<RxDocType = any>(\r\n    ids: string[]\r\n  ): Promise<Map<string, RxLocalDocumentData<RxDocType>>> {\r\n    const localState = this.getLocalState();\r\n\r\n    const ret: Map<string, RxLocalDocumentData<RxDocType>> = new Map();\r\n\r\n    const db = await localState.getDb();\r\n    const store = await db.transaction(this.collectionName, \"readwrite\").store;\r\n    for (const id of ids) {\r\n      const documentInDb = await store.get(id);\r\n      if (documentInDb && !documentInDb._deleted) {\r\n        // TODO: stripKey(documentInDb) ?\r\n        ret.set(id, documentInDb);\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n  changeStream(): Observable<\r\n    RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any }>>\r\n  > {\r\n    return this.changes$.asObservable();\r\n  }\r\n\r\n  async close(): Promise<void> {\r\n    this.closed = true;\r\n    this.changes$.complete();\r\n    IDB_DATABASE_STATE_BY_NAME.delete(this.databaseName);\r\n\r\n    const localState = this.getLocalState();\r\n    const db = await localState.getDb();\r\n    db.close();\r\n  }\r\n  async remove(): Promise<void> {\r\n    this.close();\r\n    // TODO: it can be a problem actually.\r\n    // The connection is not actually closed until all transactions created using this connection are complete.\r\n    await deleteDB(this.databaseName);\r\n    this.closed = true;\r\n  }\r\n\r\n  private getLocalState() {\r\n    const localState = this.internals.databaseState;\r\n    if (!localState) {\r\n      throw new Error(\r\n        `localState(keyVal storage) is undefind (dbName: ${this.databaseName})`\r\n      );\r\n    }\r\n\r\n    return localState;\r\n  }\r\n}\r\n\r\nexport async function createBrowserKeyValueStorageLocalState(\r\n  params: RxKeyObjectStorageInstanceCreationParams<BrowserStorageSettings>\r\n): Promise<BrowserStorageInternals> {\r\n  const primaryPath = \"_id\";\r\n\r\n  const databaseState = await getIdbDatabase(\r\n    params.databaseName,\r\n    params.collectionName,\r\n    \"_id\",\r\n    { indexes: [], version: 1 }\r\n  );\r\n\r\n  return {\r\n    databaseState,\r\n    primaryPath,\r\n  };\r\n}\r\n\r\nexport const createBrowserKeyObjectStorageInstance = async (\r\n  params: RxKeyObjectStorageInstanceCreationParams<BrowserStorageSettings>\r\n) => {\r\n  const internals: BrowserStorageInternals =\r\n    await createBrowserKeyValueStorageLocalState(params);\r\n\r\n  const instance = new RxStorageKeyObjectInstanceLoki(\r\n    params.databaseName,\r\n    params.collectionName,\r\n    {},\r\n    internals\r\n  );\r\n\r\n  /**\r\n   * TODO: should we do extra steps to enable CORRECT multiinstance?\r\n   */\r\n\r\n  return instance;\r\n};\r\n"],"file":"rx-browser-key-object-storage-instance.js"}