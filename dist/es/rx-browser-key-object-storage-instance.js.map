{"version":3,"sources":["../../src/rx-browser-key-object-storage-instance.ts"],"names":["instanceId","RxBrowserKeyObjectStorageInstance","databaseName","collectionName","options","internals","changes$","Subject","closed","bulkWrite","documentWrites","length","args","ret","success","error","getLocalState","getDb","db","txn","transaction","store","writeRowById","Map","startTime","Date","now","writeRow","id","document","_id","set","openCursor","documentInDbCursor","writeDoc","Object","assign","docInDb","value","previous","newRevHeight","_rev","height","newRevision","err","isError","status","documentId","_deleted","docCpy","update","add","endTime","event","operation","doc","previousDoc","eventId","storageChangeEvent","change","next","commit","findLocalDocumentsById","ids","localState","get","documentInDb","changeStream","asObservable","close","IDB_DATABASE_STATE_BY_NAME","complete","remove","removeCollection","databaseState","Error","createBrowserKeyValueStorageLocalState","params","primaryPath","indexes","version","changesCollectionName","createBrowserKeyObjectStorageInstance","_params","instance"],"mappings":";;;;;;;;;;;;;;;;AACA;;AAWA;;AACA;;AAUA;;;;;;;;;;;;AAEA,IAAIA,UAAU,GAAG,CAAjB;;IAEaC,iC;AAUX,6CACkBC,YADlB,EAEkBC,cAFlB,EAGkBC,OAHlB,EAIkBC,SAJlB,CAIqD;AAJrD,IAKE,CACA;;AADA,SAXMC,QAWN,GATE,IAAIC,aAAJ,EASF;AAAA,SARcP,UAQd,GAR2BA,UAAU,EAQrC;AAAA,SAPMQ,MAON,GAPe,KAOf;AAAA,SAJgBN,YAIhB,GAJgBA,YAIhB;AAAA,SAHgBC,cAGhB,GAHgBA,cAGhB;AAAA,SAFgBC,OAEhB,GAFgBA,OAEhB;AAAA,SADgBC,SAChB,GADgBA,SAChB;AAED;;;;SAEKI,S;mGAAN,iBACEC,cADF;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,oBAGMA,cAAc,CAACC,MAAf,KAA0B,CAHhC;AAAA;AAAA;AAAA;;AAAA,oBAIU,2BAAW,IAAX,EAAiB;AACrBC,gBAAAA,IAAI,EAAE;AACJF,kBAAAA,cAAc,EAAdA;AADI;AADe,eAAjB,CAJV;;AAAA;AAWQG,cAAAA,GAXR,GAW0D;AACtDC,gBAAAA,OAAO,EAAE,EAD6C;AAEtDC,gBAAAA,KAAK,EAAE;AAF+C,eAX1D;;AAAA,mBAgBM,KAAKP,MAhBX;AAAA;AAAA;AAAA;;AAAA,+CAiBWK,GAjBX;;AAAA;AAAA;AAAA,qBAoBmB,KAAKG,aAAL,GAAqBC,KAArB,EApBnB;;AAAA;AAoBQC,cAAAA,EApBR;AAqBQC,cAAAA,GArBR,GAqBcD,EAAE,CAACE,WAAH,CAAe,KAAKjB,cAApB,EAAoC,WAApC,CArBd;AAsBQkB,cAAAA,KAtBR,GAsBgBF,GAAG,CAACE,KAtBpB;AAwBQC,cAAAA,YAxBR,GAwBkE,IAAIC,GAAJ,EAxBlE;AAyBQC,cAAAA,SAzBR,GAyBoBC,IAAI,CAACC,GAAL,EAzBpB;AAAA,0DA2ByBhB,cA3BzB;;AAAA;AAAA;AAAA;AAAA;AAAA;;AA2BaiB,cAAAA,QA3Bb;AA4BUC,cAAAA,EA5BV,GA4BeD,QAAQ,CAACE,QAAT,CAAkBC,GA5BjC;AA6BIR,cAAAA,YAAY,CAACS,GAAb,CAAiBH,EAAjB,EAAqBD,QAArB;AA7BJ;AAAA,qBA8BqCN,KAAK,CAACW,UAAN,CAAiBJ,EAAjB,CA9BrC;;AAAA;AA8BUK,cAAAA,kBA9BV;AA+BUC,cAAAA,QA/BV,GA+BqBC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBT,QAAQ,CAACE,QAA3B,CA/BrB;AAgCUQ,cAAAA,OAhCV,GAgCoBJ,kBAhCpB,aAgCoBA,kBAhCpB,uBAgCoBA,kBAAkB,CAAEK,KAhCxC;AAiCUC,cAAAA,QAjCV,GAiCqBZ,QAAQ,CAACY,QAAT,GAAoBZ,QAAQ,CAACY,QAA7B,GAAwCF,OAjC7D;AAkCUG,cAAAA,YAlCV,GAkCyBD,QAAQ,GACzB,yBAAcA,QAAQ,CAACE,IAAvB,EAA6BC,MAA7B,GAAsC,CADb,GAEzB,CApCR;AAqCUC,cAAAA,WArCV,GAsCMH,YAAY,GAAG,GAAf,GAAqB,0BAAeb,QAAQ,CAACE,QAAxB,CAtC3B;AAuCIK,cAAAA,QAAQ,CAACO,IAAT,GAAgBE,WAAhB;;AAvCJ,mBAwCQN,OAxCR;AAAA;AAAA;AAAA;;AAAA,oBAyCU,CAACV,QAAQ,CAACY,QAAV,IAAsBF,OAAO,CAACI,IAAR,KAAiBd,QAAQ,CAACY,QAAT,CAAkBE,IAzCnE;AAAA;AAAA;AAAA;;AA0CQ;AACMG,cAAAA,GA3Cd,GA2C6D;AACnDC,gBAAAA,OAAO,EAAE,IAD0C;AAEnDC,gBAAAA,MAAM,EAAE,GAF2C;AAGnDC,gBAAAA,UAAU,EAAEnB,EAHuC;AAInDD,gBAAAA,QAAQ,EAAEA;AAJyC,eA3C7D;AAiDQd,cAAAA,GAAG,CAACE,KAAJ,CAAUa,EAAV,IAAgBgB,GAAhB;AAjDR;;AAAA;AAAA,kBAmDkBjB,QAAQ,CAACE,QAAT,CAAkBmB,QAnDpC;AAAA;AAAA;AAAA;;AAoDcC,cAAAA,MApDd,GAoD4Bd,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBF,QAAlB,CApD5B;AAAA;AAAA,qBAqDcD,kBAAkB,CAACiB,MAAnB,CAA0BD,MAA1B,CArDd;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,qBAwDchB,kBAAkB,UAAlB,EAxDd;;AAAA;AAAA;AAAA;;AAAA;AAAA,kBA0DgBN,QAAQ,CAACE,QAAT,CAAkBmB,QA1DlC;AAAA;AAAA;AAAA;;AAAA;AAAA,qBA4DY3B,KAAK,CAAC8B,GAAN,CAAUhB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBF,QAAlB,CAAV,CA5DZ;;AAAA;AA+DIrB,cAAAA,GAAG,CAACC,OAAJ,CAAYc,EAAZ,IAAkBM,QAAlB;AAEMkB,cAAAA,OAjEV,GAiEoB3B,IAAI,CAACC,GAAL,EAjEpB;AAmEQ2B,cAAAA,KAnER;;AAoEI,kBAAI,CAAC1B,QAAQ,CAACY,QAAd,EAAwB;AACtB;AACAc,gBAAAA,KAAK,GAAG;AACNC,kBAAAA,SAAS,EAAE,QADL;AAENC,kBAAAA,GAAG,EAAErB,QAFC;AAGNN,kBAAAA,EAAE,EAAEA,EAHE;AAINW,kBAAAA,QAAQ,EAAE;AAJJ,iBAAR;AAMD,eARD,MAQO,IAAIZ,QAAQ,CAACE,QAAT,CAAkBmB,QAAtB,EAAgC;AACrC;AAEA;AACA;AACA;AACMQ,gBAAAA,WAN+B,GAMjBrB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBT,QAAQ,CAACY,QAA3B,CANiB;AAOrCiB,gBAAAA,WAAW,CAACf,IAAZ,GAAmBE,WAAnB;AAEAU,gBAAAA,KAAK,GAAG;AACNC,kBAAAA,SAAS,EAAE,QADL;AAENC,kBAAAA,GAAG,EAAE,IAFC;AAGN3B,kBAAAA,EAAE,EAAFA,EAHM;AAINW,kBAAAA,QAAQ,EAAEiB;AAJJ,iBAAR;AAMD,eAfM,MAeA;AACL;AACAH,gBAAAA,KAAK,GAAG;AACNC,kBAAAA,SAAS,EAAE,QADL;AAENC,kBAAAA,GAAG,EAAErB,QAFC;AAGNN,kBAAAA,EAAE,EAAEA,EAHE;AAINW,kBAAAA,QAAQ,EAAEZ,QAAQ,CAACY;AAJb,iBAAR;AAMD;;AAED,kBACEZ,QAAQ,CAACE,QAAT,CAAkBmB,QAAlB,KACC,CAACrB,QAAQ,CAACY,QAAV,IAAsBZ,QAAQ,CAACY,QAAT,CAAkBS,QADzC,CADF,EAGE;AACA;AACR;AACA;AACA;AACO,eARD,MAQO;AACCO,gBAAAA,GADD,GAEHF,KAAK,CAACC,SAAN,KAAoB,QAApB,GACKD,KAAK,CAACd,QADX,GAEKc,KAAK,CAACE,GAJR;AAKCE,gBAAAA,OALD,GAKW,wBAAY,IAAZ,EAAkBF,GAAG,CAACzB,GAAtB,EAA2ByB,GAAG,CAACd,IAAJ,GAAWc,GAAG,CAACd,IAAf,GAAsB,EAAjD,CALX;AAMCiB,gBAAAA,kBAND,GAQD;AACFD,kBAAAA,OAAO,EAAPA,OADE;AAEFV,kBAAAA,UAAU,EAAEnB,EAFV;AAGF+B,kBAAAA,MAAM,EAAEN,KAHN;AAIF7B,kBAAAA,SAAS,EAATA,SAJE;AAKF4B,kBAAAA,OAAO,EAAPA;AALE,iBARC,EAeL;;AACA,qBAAK9C,QAAL,CAAcsD,IAAd,CAAmBF,kBAAnB;AACD;;AA9HL;AAAA;AAAA;;AAAA;AAiIEvC,cAAAA,GAAG,CAAC0C,MAAJ;AAjIF,+CAkIShD,GAlIT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K;;;;;;;;;SAqIMiD,sB;gHAAN,kBAA8CC,GAA9C;AAAA;;AAAA;AAAA;AAAA;AAAA;AACQlD,cAAAA,GADR,GACwE,EADxE;;AAAA,mBAGM,KAAKL,MAHX;AAAA;AAAA;AAAA;;AAAA,gDAIWK,GAJX;;AAAA;AAOQmD,cAAAA,UAPR,GAOqB,KAAKhD,aAAL,EAPrB;AAAA;AAAA,qBASmBgD,UAAU,CAAC/C,KAAX,EATnB;;AAAA;AASQC,cAAAA,EATR;AAAA;AAAA,qBAUsBA,EAAE,CAACE,WAAH,CAAe,KAAKjB,cAApB,EAAoC,WAApC,EAAiDkB,KAVvE;;AAAA;AAUQA,cAAAA,KAVR;AAAA,2DAWmB0C,GAXnB;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAWanC,cAAAA,EAXb;AAAA;AAAA,qBAY+BP,KAAK,CAAC4C,GAAN,CAAUrC,EAAV,CAZ/B;;AAAA;AAYUsC,cAAAA,YAZV;;AAaI,kBAAIA,YAAY,IAAI,CAACA,YAAY,CAAClB,QAAlC,EAA4C;AAC1CnC,gBAAAA,GAAG,CAACe,EAAD,CAAH,GAAUsC,YAAV;AACD;;AAfL;AAAA;AAAA;;AAAA;AAAA,gDAkBSrD,GAlBT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K;;;;;;;;;SAoBAsD,Y,GAAA,wBAEE;AACA,WAAO,KAAK7D,QAAL,CAAc8D,YAAd,EAAP;AACD,G;;SAEKC,K;+FAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AACE,mBAAK7D,MAAL,GAAc,IAAd;;AADF,kBAGO8D,sCAA2BL,GAA3B,CAA+B,KAAK/D,YAApC,CAHP;AAAA;AAAA;AAAA;;AAAA;;AAAA;AASE,mBAAKI,QAAL,CAAciE,QAAd;AACMP,cAAAA,UAVR,GAUqB,KAAKhD,aAAL,EAVrB;AAAA;AAAA,qBAWmBgD,UAAU,CAAC/C,KAAX,EAXnB;;AAAA;AAWQC,cAAAA,EAXR;AAYEA,cAAAA,EAAE,CAACmD,KAAH;;AACAC,8DAAkC,KAAKpE,YAAvC;;AAbF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K;;;;;;;;;SAeMsE,M;gGAAN;AAAA;AAAA;AAAA;AAAA;AAAA;AACQR,cAAAA,UADR,GACqB,KAAKhD,aAAL,EADrB;AAAA;AAAA,qBAEQgD,UAAU,CAACS,gBAAX,EAFR;;AAAA;AAGE,mBAAKjE,MAAL,GAAc,IAAd;;AAHF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K;;;;;;;;;SAMQQ,a,GAAR,yBAAwB;AACtB,QAAMgD,UAAU,GAAG,KAAK3D,SAAL,CAAeqE,aAAlC;;AACA,QAAI,CAACV,UAAL,EAAiB;AACf,YAAM,IAAIW,KAAJ,sDAC+C,KAAKzE,YADpD,OAAN;AAGD;;AAED,WAAO8D,UAAP;AACD,G;;;;;;;SAGmBY,sC;;;;;0HAAf,kBACLC,MADK;AAAA;AAAA;AAAA;AAAA;AAAA;AAGCC,YAAAA,WAHD,GAGe,KAHf;AAAA;AAAA,mBAKuB,kCAC1BD,MAAM,CAAC3E,YADmB,EAE1B2E,MAAM,CAAC1E,cAFmB,EAG1B,KAH0B,EAI1B;AAAE4E,cAAAA,OAAO,EAAE,EAAX;AAAeC,cAAAA,OAAO,EAAE;AAAxB,aAJ0B,CALvB;;AAAA;AAKCN,YAAAA,aALD;AAAA,8CAYE;AACLA,cAAAA,aAAa,EAAbA,aADK;AAELO,cAAAA,qBAAqB,EAAE,mCAAmBJ,MAAM,CAAC1E,cAA1B,CAFlB;AAGL2E,cAAAA,WAAW,EAAXA;AAHK,aAZF;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AAmBA,IAAMI,qCAAqC;AAAA,2FAAG,kBACnDC,OADmD;AAAA;AAAA;AAAA;AAAA;AAAA;AAG7CN,YAAAA,MAH6C,mCAI9CM,OAJ8C;AAKjDjF,cAAAA,YAAY,EAAEiF,OAAO,CAACjF,YAAR,GAAuB;AALY;AAAA;AAAA,mBAQ3B0E,sCAAsC,CAACC,MAAD,CARX;;AAAA;AAQ7CxE,YAAAA,SAR6C;AAU7C+E,YAAAA,QAV6C,GAUlC,IAAInF,iCAAJ,CACf4E,MAAM,CAAC3E,YADQ,EAEf2E,MAAM,CAAC1E,cAFQ,EAGf,EAHe,EAIfE,SAJe,CAVkC;AAiBnD;AACF;AACA;;AAnBqD,8CAqB5C+E,QArB4C;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAH;;AAAA,kBAArCF,qCAAqC;AAAA;AAAA;AAAA,GAA3C","sourcesContent":["import { ChangeEvent } from \"event-reduce-js/dist/lib/types\";\r\nimport { createRevision, parseRevision } from \"rxdb\";\r\nimport {\r\n  BulkWriteLocalRow,\r\n  EventBulk,\r\n  RxKeyObjectStorageInstanceCreationParams,\r\n  RxLocalDocumentData,\r\n  RxLocalStorageBulkWriteResponse,\r\n  RxStorageBulkWriteLocalError,\r\n  RxStorageChangeEvent,\r\n  RxStorageKeyObjectInstance,\r\n} from \"rxdb/dist/types/types\";\r\nimport { Observable, Subject } from \"rxjs\";\r\nimport {\r\n  createIdbDatabase,\r\n  getChangesCollName,\r\n  IDB_DATABASE_STATE_BY_NAME,\r\n  newRxError,\r\n} from \"./db-helpers\";\r\nimport {\r\n  BrowserStorageInternals,\r\n  BrowserStorageSettings,\r\n} from \"./types/browser-storage\";\r\nimport { getEventKey } from \"./utils\";\r\n\r\nlet instanceId = 1;\r\n\r\nexport class RxBrowserKeyObjectStorageInstance<RxDocType>\r\n  implements\r\n    RxStorageKeyObjectInstance<BrowserStorageInternals, BrowserStorageSettings>\r\n{\r\n  private changes$: Subject<\r\n    EventBulk<RxStorageChangeEvent<RxLocalDocumentData>>\r\n  > = new Subject();\r\n  public readonly instanceId = instanceId++;\r\n  private closed = false;\r\n\r\n  constructor(\r\n    public readonly databaseName: string,\r\n    public readonly collectionName: string,\r\n    public readonly options: Readonly<BrowserStorageSettings>,\r\n    public readonly internals: BrowserStorageInternals // public readonly options: Readonly<BrowserStorageSettings> // public readonly databaseSettings: BrowserStorageSettings, // public readonly idleQueue: IdleQueue\r\n  ) {\r\n    // this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\r\n  }\r\n\r\n  async bulkWrite<RxDocType>(\r\n    documentWrites: BulkWriteLocalRow<RxDocType>[]\r\n  ): Promise<RxLocalStorageBulkWriteResponse<RxDocType>> {\r\n    if (documentWrites.length === 0) {\r\n      throw newRxError(\"P2\", {\r\n        args: {\r\n          documentWrites,\r\n        },\r\n      });\r\n    }\r\n\r\n    const ret: RxLocalStorageBulkWriteResponse<RxDocType> = {\r\n      success: {},\r\n      error: {},\r\n    };\r\n\r\n    if (this.closed) {\r\n      return ret;\r\n    }\r\n\r\n    const db = await this.getLocalState().getDb();\r\n    const txn = db.transaction(this.collectionName, \"readwrite\");\r\n    const store = txn.store;\r\n\r\n    const writeRowById: Map<string, BulkWriteLocalRow<RxDocType>> = new Map();\r\n    const startTime = Date.now();\r\n\r\n    for (const writeRow of documentWrites) {\r\n      const id = writeRow.document._id;\r\n      writeRowById.set(id, writeRow);\r\n      const documentInDbCursor = await store.openCursor(id);\r\n      const writeDoc = Object.assign({}, writeRow.document);\r\n      const docInDb = documentInDbCursor?.value;\r\n      const previous = writeRow.previous ? writeRow.previous : docInDb;\r\n      const newRevHeight = previous\r\n        ? parseRevision(previous._rev).height + 1\r\n        : 1;\r\n      const newRevision =\r\n        newRevHeight + \"-\" + createRevision(writeRow.document);\r\n      writeDoc._rev = newRevision;\r\n      if (docInDb) {\r\n        if (!writeRow.previous || docInDb._rev !== writeRow.previous._rev) {\r\n          // conflict error\r\n          const err: RxStorageBulkWriteLocalError<RxDocType> = {\r\n            isError: true,\r\n            status: 409,\r\n            documentId: id,\r\n            writeRow: writeRow,\r\n          };\r\n          ret.error[id] = err;\r\n          continue;\r\n        } else if (!writeRow.document._deleted) {\r\n          const docCpy: any = Object.assign({}, writeDoc);\r\n          await documentInDbCursor.update(docCpy);\r\n        } else {\r\n          // TODO: purge\r\n          await documentInDbCursor.delete();\r\n        }\r\n      } else if (!writeRow.document._deleted) {\r\n        // TODO: purge\r\n        await store.add(Object.assign({}, writeDoc));\r\n      }\r\n\r\n      ret.success[id] = writeDoc;\r\n\r\n      const endTime = Date.now();\r\n\r\n      let event: ChangeEvent<RxLocalDocumentData<RxDocType>>;\r\n      if (!writeRow.previous) {\r\n        // was insert\r\n        event = {\r\n          operation: \"INSERT\",\r\n          doc: writeDoc,\r\n          id: id,\r\n          previous: null,\r\n        };\r\n      } else if (writeRow.document._deleted) {\r\n        // was delete\r\n\r\n        // we need to add the new revision to the previous doc\r\n        // so that the eventkey is calculated correctly.\r\n        // Is this a hack? idk.\r\n        const previousDoc = Object.assign({}, writeRow.previous);\r\n        previousDoc._rev = newRevision;\r\n\r\n        event = {\r\n          operation: \"DELETE\",\r\n          doc: null,\r\n          id,\r\n          previous: previousDoc,\r\n        };\r\n      } else {\r\n        // was update\r\n        event = {\r\n          operation: \"UPDATE\",\r\n          doc: writeDoc,\r\n          id: id,\r\n          previous: writeRow.previous,\r\n        };\r\n      }\r\n\r\n      if (\r\n        writeRow.document._deleted &&\r\n        (!writeRow.previous || writeRow.previous._deleted)\r\n      ) {\r\n        /**\r\n         * An already deleted document was added to the storage engine,\r\n         * do not emit an event because it does not affect anything.\r\n         */\r\n      } else {\r\n        const doc: RxLocalDocumentData<RxDocType> =\r\n          event.operation === \"DELETE\"\r\n            ? (event.previous as any)\r\n            : (event.doc as any);\r\n        const eventId = getEventKey(true, doc._id, doc._rev ? doc._rev : \"\");\r\n        const storageChangeEvent: RxStorageChangeEvent<\r\n          RxLocalDocumentData<RxDocType>\r\n        > = {\r\n          eventId,\r\n          documentId: id,\r\n          change: event,\r\n          startTime,\r\n          endTime,\r\n        };\r\n        // TODO: fix type\r\n        this.changes$.next(storageChangeEvent as any);\r\n      }\r\n    }\r\n\r\n    txn.commit();\r\n    return ret;\r\n  }\r\n\r\n  async findLocalDocumentsById<RxDocType = any>(ids: string[]) {\r\n    const ret: { [documentId: string]: RxLocalDocumentData<RxDocType> } = {};\r\n\r\n    if (this.closed) {\r\n      return ret;\r\n    }\r\n\r\n    const localState = this.getLocalState();\r\n\r\n    const db = await localState.getDb();\r\n    const store = await db.transaction(this.collectionName, \"readwrite\").store;\r\n    for (const id of ids) {\r\n      const documentInDb = await store.get(id);\r\n      if (documentInDb && !documentInDb._deleted) {\r\n        ret[id] = documentInDb;\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n  changeStream(): Observable<\r\n    EventBulk<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any }>>>\r\n  > {\r\n    return this.changes$.asObservable();\r\n  }\r\n\r\n  async close(): Promise<void> {\r\n    this.closed = true;\r\n\r\n    if (!IDB_DATABASE_STATE_BY_NAME.get(this.databaseName)) {\r\n      // already closed.\r\n      // different instance could already close db.\r\n      return;\r\n    }\r\n\r\n    this.changes$.complete();\r\n    const localState = this.getLocalState();\r\n    const db = await localState.getDb();\r\n    db.close();\r\n    IDB_DATABASE_STATE_BY_NAME.delete(this.databaseName);\r\n  }\r\n  async remove(): Promise<void> {\r\n    const localState = this.getLocalState();\r\n    await localState.removeCollection();\r\n    this.closed = true;\r\n  }\r\n\r\n  private getLocalState() {\r\n    const localState = this.internals.databaseState;\r\n    if (!localState) {\r\n      throw new Error(\r\n        `localState(keyVal storage) is undefind (dbName: ${this.databaseName})`\r\n      );\r\n    }\r\n\r\n    return localState;\r\n  }\r\n}\r\n\r\nexport async function createBrowserKeyValueStorageLocalState(\r\n  params: RxKeyObjectStorageInstanceCreationParams<BrowserStorageSettings>\r\n): Promise<BrowserStorageInternals> {\r\n  const primaryPath = \"_id\";\r\n\r\n  const databaseState = await createIdbDatabase(\r\n    params.databaseName,\r\n    params.collectionName,\r\n    \"_id\",\r\n    { indexes: [], version: 0 }\r\n  );\r\n\r\n  return {\r\n    databaseState,\r\n    changesCollectionName: getChangesCollName(params.collectionName),\r\n    primaryPath,\r\n  };\r\n}\r\n\r\nexport const createBrowserKeyObjectStorageInstance = async <RxDocType>(\r\n  _params: RxKeyObjectStorageInstanceCreationParams<BrowserStorageInternals>\r\n) => {\r\n  const params: typeof _params = {\r\n    ..._params,\r\n    databaseName: _params.databaseName + \"-key-object\",\r\n  };\r\n\r\n  const internals = await createBrowserKeyValueStorageLocalState(params);\r\n\r\n  const instance = new RxBrowserKeyObjectStorageInstance<RxDocType>(\r\n    params.databaseName,\r\n    params.collectionName,\r\n    {},\r\n    internals\r\n  );\r\n\r\n  /**\r\n   * TODO: should we do extra steps to enable CORRECT multiinstance?\r\n   */\r\n\r\n  return instance;\r\n};\r\n"],"file":"rx-browser-key-object-storage-instance.js"}