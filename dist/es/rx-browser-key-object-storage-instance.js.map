{"version":3,"sources":["../../src/rx-browser-key-object-storage-instance.ts"],"names":["instanceId","RxBrowserKeyObjectStorageInstance","databaseName","collectionName","options","internals","changes$","Subject","closed","bulkWrite","documentWrites","length","args","ret","success","error","getLocalState","getDb","db","txn","transaction","store","eventBulk","id","events","writeRowById","Map","startTime","Date","now","writeRow","document","_id","set","openCursor","documentInDbCursor","writeDoc","Object","assign","docInDb","value","previous","newRevHeight","_rev","height","newRevision","err","isError","status","documentId","docCpy","update","add","endTime","event","operation","doc","_deleted","previousDoc","eventId","storageChangeEvent","change","push","commit","next","findLocalDocumentsById","ids","localState","get","documentInDb","changeStream","asObservable","close","complete","IDB_DATABASE_STATE_BY_NAME","remove","removeDb","databaseState","Error","createBrowserKeyValueStorageLocalState","params","idbSettings","primaryPath","schema","indexes","version","changesCollectionName","createBrowserKeyObjectStorageInstance","_params","instance"],"mappings":"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","sourcesContent":["import { ChangeEvent } from \"event-reduce-js/dist/lib/types\";\r\nimport { createRevision, parseRevision, randomCouchString } from \"rxdb\";\r\nimport {\r\n  BulkWriteLocalRow,\r\n  EventBulk,\r\n  RxKeyObjectStorageInstanceCreationParams,\r\n  RxLocalDocumentData,\r\n  RxLocalStorageBulkWriteResponse,\r\n  RxStorageBulkWriteLocalError,\r\n  RxStorageChangeEvent,\r\n  RxStorageKeyObjectInstance,\r\n} from \"rxdb/dist/types/types\";\r\nimport { Observable, Subject } from \"rxjs\";\r\nimport {\r\n  createIdbDatabase,\r\n  getChangesCollName,\r\n  getDbName,\r\n  IDB_DATABASE_STATE_BY_NAME,\r\n  newRxError,\r\n} from \"./db-helpers\";\r\nimport { BrowserStorageInternals, IdbSettings } from \"./types/browser-storage\";\r\nimport { getEventKey } from \"./utils\";\r\n\r\nlet instanceId = 1;\r\n\r\nexport class RxBrowserKeyObjectStorageInstance<RxDocType>\r\n  implements RxStorageKeyObjectInstance<BrowserStorageInternals, IdbSettings>\r\n{\r\n  private changes$: Subject<\r\n    EventBulk<RxStorageChangeEvent<RxLocalDocumentData>>\r\n  > = new Subject();\r\n  public readonly instanceId = instanceId++;\r\n  private closed = false;\r\n\r\n  constructor(\r\n    public readonly databaseName: string,\r\n    public readonly collectionName: string,\r\n    public readonly options: Readonly<IdbSettings>,\r\n    public readonly internals: BrowserStorageInternals // public readonly options: Readonly<BrowserStorageSettings> // public readonly databaseSettings: BrowserStorageSettings, // public readonly idleQueue: IdleQueue\r\n  ) {\r\n    // this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\r\n  }\r\n\r\n  async bulkWrite<RxDocType>(\r\n    documentWrites: BulkWriteLocalRow<RxDocType>[]\r\n  ): Promise<RxLocalStorageBulkWriteResponse<RxDocType>> {\r\n    if (documentWrites.length === 0) {\r\n      throw newRxError(\"P2\", {\r\n        args: {\r\n          documentWrites,\r\n        },\r\n      });\r\n    }\r\n\r\n    const ret: RxLocalStorageBulkWriteResponse<RxDocType> = {\r\n      success: {},\r\n      error: {},\r\n    };\r\n\r\n    if (this.closed) {\r\n      return ret;\r\n    }\r\n\r\n    const db = await this.getLocalState().getDb();\r\n    const txn = db.transaction(this.collectionName, \"readwrite\");\r\n    const store = txn.store;\r\n\r\n    const eventBulk: EventBulk<RxStorageChangeEvent<RxLocalDocumentData>> = {\r\n      id: randomCouchString(10),\r\n      events: [],\r\n    };\r\n    const writeRowById: Map<string, BulkWriteLocalRow<RxDocType>> = new Map();\r\n    const startTime = Date.now();\r\n\r\n    for (const writeRow of documentWrites) {\r\n      const id = writeRow.document._id;\r\n      writeRowById.set(id, writeRow);\r\n      const documentInDbCursor = await store.openCursor(id);\r\n      const writeDoc = Object.assign({}, writeRow.document);\r\n      const docInDb = documentInDbCursor?.value;\r\n      const previous = writeRow.previous ? writeRow.previous : docInDb;\r\n      const newRevHeight = previous\r\n        ? parseRevision(previous._rev).height + 1\r\n        : 1;\r\n      const newRevision =\r\n        newRevHeight + \"-\" + createRevision(writeRow.document);\r\n      writeDoc._rev = newRevision;\r\n      if (docInDb) {\r\n        if (!writeRow.previous || docInDb._rev !== writeRow.previous._rev) {\r\n          // conflict error\r\n          const err: RxStorageBulkWriteLocalError<RxDocType> = {\r\n            isError: true,\r\n            status: 409,\r\n            documentId: id,\r\n            writeRow: writeRow,\r\n          };\r\n          ret.error[id] = err;\r\n          continue;\r\n        } else {\r\n          const docCpy: any = Object.assign({}, writeDoc);\r\n          await documentInDbCursor.update(docCpy);\r\n        }\r\n      } else {\r\n        await store.add(Object.assign({}, writeDoc));\r\n      }\r\n\r\n      ret.success[id] = writeDoc;\r\n\r\n      const endTime = Date.now();\r\n\r\n      let event: ChangeEvent<RxLocalDocumentData<RxDocType>>;\r\n      if (!writeRow.previous) {\r\n        // was insert\r\n        event = {\r\n          operation: \"INSERT\",\r\n          doc: writeDoc,\r\n          id: id,\r\n          previous: null,\r\n        };\r\n      } else if (writeRow.document._deleted) {\r\n        // was delete\r\n\r\n        // we need to add the new revision to the previous doc\r\n        // so that the eventkey is calculated correctly.\r\n        // Is this a hack? idk.\r\n        const previousDoc = Object.assign({}, writeRow.previous);\r\n        previousDoc._rev = newRevision;\r\n\r\n        event = {\r\n          operation: \"DELETE\",\r\n          doc: null,\r\n          id,\r\n          previous: previousDoc,\r\n        };\r\n      } else {\r\n        // was update\r\n        event = {\r\n          operation: \"UPDATE\",\r\n          doc: writeDoc,\r\n          id: id,\r\n          previous: writeRow.previous,\r\n        };\r\n      }\r\n\r\n      if (\r\n        writeRow.document._deleted &&\r\n        (!writeRow.previous || writeRow.previous._deleted)\r\n      ) {\r\n        /**\r\n         * An already deleted document was added to the storage engine,\r\n         * do not emit an event because it does not affect anything.\r\n         */\r\n      } else {\r\n        const doc: RxLocalDocumentData<RxDocType> =\r\n          event.operation === \"DELETE\"\r\n            ? (event.previous as any)\r\n            : (event.doc as any);\r\n        const eventId = getEventKey(true, doc._id, doc._rev ? doc._rev : \"\");\r\n        const storageChangeEvent: RxStorageChangeEvent<\r\n          RxLocalDocumentData<RxDocType>\r\n        > = {\r\n          eventId,\r\n          documentId: id,\r\n          change: event,\r\n          startTime,\r\n          endTime,\r\n        };\r\n        eventBulk.events.push(storageChangeEvent);\r\n      }\r\n    }\r\n\r\n    txn.commit();\r\n    this.changes$.next(eventBulk);\r\n    return ret;\r\n  }\r\n\r\n  async findLocalDocumentsById<RxDocType = any>(ids: string[]) {\r\n    const ret: { [documentId: string]: RxLocalDocumentData<RxDocType> } = {};\r\n\r\n    if (this.closed) {\r\n      return ret;\r\n    }\r\n\r\n    const localState = this.getLocalState();\r\n\r\n    const db = await localState.getDb();\r\n    const store = await db.transaction(this.collectionName, \"readwrite\").store;\r\n    for (const id of ids) {\r\n      const documentInDb = await store.get(id);\r\n      if (documentInDb && !documentInDb._deleted) {\r\n        ret[id] = documentInDb;\r\n      }\r\n    }\r\n\r\n    return ret;\r\n  }\r\n  changeStream(): Observable<\r\n    EventBulk<RxStorageChangeEvent<RxLocalDocumentData<{ [key: string]: any }>>>\r\n  > {\r\n    return this.changes$.asObservable();\r\n  }\r\n\r\n  async close(): Promise<void> {\r\n    this.changes$.complete();\r\n    const localState = this.getLocalState();\r\n    const db = await localState.getDb();\r\n    db.close();\r\n    IDB_DATABASE_STATE_BY_NAME.delete(\r\n      getDbName(this.databaseName, this.collectionName)\r\n    );\r\n    this.closed = true;\r\n  }\r\n  async remove(): Promise<void> {\r\n    const localState = this.getLocalState();\r\n    await localState.removeDb();\r\n    this.closed = true;\r\n  }\r\n\r\n  private getLocalState() {\r\n    const localState = this.internals.databaseState;\r\n    if (!localState) {\r\n      throw new Error(\r\n        `localState(keyVal storage) is undefind (dbName: ${this.databaseName})`\r\n      );\r\n    }\r\n\r\n    return localState;\r\n  }\r\n}\r\n\r\nexport async function createBrowserKeyValueStorageLocalState(\r\n  params: RxKeyObjectStorageInstanceCreationParams<IdbSettings>,\r\n  idbSettings: IdbSettings\r\n): Promise<BrowserStorageInternals> {\r\n  const primaryPath = \"_id\";\r\n\r\n  const databaseState = await createIdbDatabase({\r\n    databaseName: params.databaseName,\r\n    collectionName: params.collectionName,\r\n    primaryPath: \"_id\",\r\n    schema: { indexes: [], version: 0 },\r\n    idbSettings,\r\n  });\r\n\r\n  return {\r\n    databaseState,\r\n    changesCollectionName: getChangesCollName(),\r\n    primaryPath,\r\n  };\r\n}\r\n\r\nexport const createBrowserKeyObjectStorageInstance = async <RxDocType>(\r\n  _params: RxKeyObjectStorageInstanceCreationParams<IdbSettings>,\r\n  idbSettings: IdbSettings\r\n) => {\r\n  const params: typeof _params = {\r\n    ..._params,\r\n    databaseName: _params.databaseName + \"-key-object\",\r\n  };\r\n\r\n  const internals = await createBrowserKeyValueStorageLocalState(\r\n    params,\r\n    idbSettings\r\n  );\r\n\r\n  const instance = new RxBrowserKeyObjectStorageInstance<RxDocType>(\r\n    params.databaseName,\r\n    params.collectionName,\r\n    {},\r\n    internals\r\n  );\r\n\r\n  /**\r\n   * TODO: should we do extra steps to enable CORRECT multiinstance?\r\n   */\r\n\r\n  return instance;\r\n};\r\n"],"file":"rx-browser-key-object-storage-instance.js"}